<!DOCTYPE HTML>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Perfil</title>
    <!-- CSRF meta tags para AJAX -->
    <!-- solo renderizar meta CSRF si _csrf existe -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!--websocket-->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="icon" th:href="@{/imagenes/isologo.png}" type="image/x-icon">

    <link rel="stylesheet" th:href="@{/css/variables.css}"/>
    <link rel="stylesheet" th:href="@{/css/base.css}"/>
    <link rel="stylesheet" th:href="@{/css/perfil.css}"/>
    <link rel="stylesheet" th:href="@{/css/home.css}"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <!-- cargamos el módulo JS que maneja pestañas + AJAX -->
    <script type="module" th:src="@{/js/notificaciones.js}" defer></script>
</head>
<body th:data-es-propio="${esPropio}">
<header>
    <nav th:replace="templates/nav :: nav"></nav>
</header>

<main class="contenedor_box_general">
    <aside class="contenedor_usuario">
        <!-- (mantengo tu aside tal cual) -->
        <div class="estructura">
            <img id="perfilFoto" class="user"
                 th:src="@{${#strings.isEmpty(usuario.fotoPerfil) ? '/imagenes/user.png' : '/' + usuario.fotoPerfil}}"
                 alt="Foto de perfil">
            <h2 class="palabra" th:text="${usuario.nombre}"></h2>
            <h2 class="palabra" th:text="${usuario.apellido}"></h2>
            <ul>
                <li class="titulo" th:text="${usuario.carrera != null ? usuario.carrera.nombre : 'Sin carrera'}">Carrera</li>
            </ul>
        </div>
        <div th:if="${esPropio}">
            <a th:href="@{/mis-likes.html}" class="btn-mis-likes">Mis Likes</a>
            <hr>
            <a th:href="@{/editar-informacion}">Editar Información</a>
            <!-- popup cambiar foto ... (lo dejé igual) -->
        </div>
    </aside>

    <section class="estructura">
        <h1>Notificaciones</h1>

        <!-- TAB-BAR (opcional, si querés pestañas) -->
        <nav class="notificaciones-tabs">
            <button class="notificaciones-tab-button" data-tab="todas">Todas</button>
            <button class="notificaciones-tab-button" data-tab="solicitudes">Solicitudes</button>
            <button class="notificaciones-tab-button" data-tab="mensajes">Mensajes</button>
        </nav>

        <div class="notificaciones">
            <!-- Pestaña 'todas' -->
            <section class="notificaciones-tab-content" data-tab-content="todas">
                <ul>
                    <li th:each="n : ${notificaciones}"
                        th:classappend="${n.leida} ? ' leida' : ' noleida'"
                        th:attr="data-notificacion-id=${n.id}, data-url=${n.url}">
                        <div th:if="${n.publicacion != null}">
                            <a th:href="@{/publicacion/{id}(id=${n.publicacion.id})}" th:text="${n.mensaje}"></a>
                        </div>
                        <div th:if="${n.publicacion == null}">
                            <span th:text="${n.mensaje}"></span>
                        </div>
                        <!-- Reemplazar el contenido dentro del <li th:each="n : ${notificaciones}"> -->
                        <div th:if="${n.publicacion != null}">
                            <a th:href="@{/publicacion/{id}(id=${n.publicacion.id})}" th:text="${n.mensaje}"></a>
                        </div>
                        <div th:if="${n.publicacion == null}">
                            <span th:text="${n.mensaje}"></span>
                        </div>

                        <!-- Si es solicitud de amistad mostrar botones -->
                        <div th:if="${n.tipo.name() == 'SOLICITUD_AMISTAD'}" class="acciones-solicitud">
                            <button type="button" class="btn-aceptar"
                                    th:attr="data-url=${n.url}, data-notificacion-id=${n.id}">Aceptar</button>
                            <button type="button" class="btn-rechazar"
                                    th:attr="data-url=${n.url}, data-notificacion-id=${n.id}">Rechazar</button>
                        </div>                    </li>
                </ul>
            </section>

            <!-- Pestaña 'solicitudes' (AJAX variant) -->
            <section class="notificaciones-tab-content" data-tab-content="solicitudes" style="display:none">
                <ul class="lista-solicitudes">
                    <!-- iteramos las notificaciones y filtramos las de tipo SOLICITUD_AMISTAD -->
                    <li th:each="n : ${notificaciones}"
                        th:if="${n.tipo.name() == 'SOLICITUD_AMISTAD'}"
                        th:classappend="${n.leida} ? ' leida' : ' noleida'"
                        th:attr="data-notificacion-id=${n.id}, data-url=${n.url}">
                        <div class="solicitud-contenido">
                            <img th:src="@{${n.usuarioEmisor != null && n.usuarioEmisor.fotoPerfil != null ? '/' + n.usuarioEmisor.fotoPerfil : '/imagenes/user.png'}}" alt="avatar" class="thumb">
                            <div class="info">
                                <strong th:text="${n.usuarioEmisor.nombre + ' ' + n.usuarioEmisor.apellido}">Nombre</strong>
                                <div class="texto" th:text="${n.mensaje}">Texto notificación</div>
                            </div>
                        </div>

                        <div class="acciones-solicitud">
                            <!-- Botones AJAX: data-url contiene la URL (ej: /notificaciones?tab=solicitudes&solicitudId=NN)
                                 El JS extraerá solicitudId de esa URL para llamar a /amistad/aceptar/{id} -->
                            <button type="button" class="btn btn-small btn-aceptar"
                                    data-action="aceptar-solicitud"
                                    th:attr="data-url=${n.url}, data-notificacion-id=${n.id}">Aceptar</button>

                            <button type="button" class="btn btn-small btn-rechazar"
                                    data-action="rechazar-solicitud"
                                    th:attr="data-url=${n.url}, data-notificacion-id=${n.id}">Rechazar</button>
                        </div>
                    </li>
                </ul>
            </section>

            <!-- Pestaña 'mensajes' (si la necesitás) -->
            <section class="notificaciones-tab-content" data-tab-content="mensajes" style="display:none">
                <p>No hay mensajes.</p>
            </section>
        </div>
    </section>
</main>

<script type="module" th:src="@{js/foto-perfil.js}"></script>
<script type="module" th:src="@{js/tema.js}"></script>
<script type="module" th:src="@{js/login.js}"></script>
<script type="module" th:src="@{js/notificaciones.js}"></script>
<script type="module" th:src="@{js/nav.js}"></script>
<!-- notificaciones.js ya lo incluimos en head con defer; si preferís aquí, comentá el head include -->
<script th:src="@{/js/publicaciones.js}"></script>
</body>
</html>